<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>駒一覧 - 盤匠</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./styles.css">
</head>
<body class="page">
  <header class="topbar">
    <button class="btn ghost" onclick="location.href='./index.html'">ホーム</button>
    <div>
      <div class="brand">駒一覧</div>
      <div class="subtitle">確認・編集・削除</div>
    </div>
  </header>

  <main class="layout">
    <section class="panel">
      <div class="card">
        <div class="label">駒一覧</div>
        <select id="piece-list" size="8"></select>
      </div>
      <div class="card">
        <div class="row">
          <button class="btn" id="edit">編集</button>
          <button class="btn secondary" id="delete">削除</button>
        </div>
        <div id="msg" class="msg err"></div>
      </div>
    </section>

    <section class="board-area">
      <div class="board-wrap">
        <div id="board" class="board"></div>
      </div>
    </section>
  </main>

  <script src="./storage.js"></script>
  <script>
    const storage = window.BansyouStorage;
    const listEl = document.getElementById("piece-list");
    const boardEl = document.getElementById("board");
    const msgEl = document.getElementById("msg");
    const editBtn = document.getElementById("edit");
    const deleteBtn = document.getElementById("delete");

    function renderPiece(data) {
      if (!data) return;
      const size = data.boardSize || 9;
      const center = data.center || { x: Math.floor(size / 2), y: Math.floor(size / 2) };
      const normals = new Set((data.moves?.normal || []).map((p) => `${p.x},${p.y}`));
      const conts = new Set((data.moves?.cont || []).map((p) => `${p.x},${p.y}`));
      boardEl.innerHTML = "";
      boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      boardEl.style.gridTemplateRows = `repeat(${size}, 1fr)`;
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          const key = `${x},${y}`;
          if (x === center.x && y === center.y) {
            cell.classList.add("center");
            cell.textContent = data.char || "駒";
          } else {
            if (normals.has(key)) cell.classList.add("step");
            if (conts.has(key)) cell.classList.add("slide");
          }
          boardEl.appendChild(cell);
        }
      }
    }

    function loadPieces() {
      const pieces = storage.listPieces();
      listEl.innerHTML = "";
      pieces.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = p.name;
        listEl.appendChild(opt);
      });
      if (pieces.length) {
        listEl.value = pieces[0].name;
        renderPiece(pieces[0]);
      }
    }

    listEl.addEventListener("change", () => {
      const data = storage.getPiece(listEl.value);
      renderPiece(data);
    });

    editBtn.addEventListener("click", () => {
      msgEl.textContent = "";
      if (!listEl.value) {
        msgEl.textContent = "駒を選択してください。";
        return;
      }
      location.href = `./piece-create.html?name=${encodeURIComponent(listEl.value)}`;
    });

    deleteBtn.addEventListener("click", () => {
      msgEl.textContent = "";
      const name = listEl.value;
      if (!name) {
        msgEl.textContent = "駒を選択してください。";
        return;
      }
      if (!confirm(`駒「${name}」を削除しますか？`)) return;
      storage.deletePiece(name);
      loadPieces();
    });

    loadPieces();
  </script>
</body>
</html>
